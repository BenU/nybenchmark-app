service: nybenchmark_app

# 1. Image Location
image: benu/nybenchmark_app

# 2. Server IP
ssh:
  user: deploy
  
servers:
  web:
    - 68.183.56.0

# 3. Global Logging Configuration (Prevents Disk Full)
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

# 4. Proxy & Domain
proxy:
  ssl: true
  host: app.nybenchmark.org
  app_port: 80
  healthcheck:
    path: /up
    interval: 5
    timeout: 5

# 5. Registry Credentials
registry:
  server: ghcr.io
  username: benu
  password:
    - KAMAL_REGISTRY_PASSWORD

# 6. Sufficient Deployment Timeout
deploy_timeout: 240
drain_timeout: 120

# 7. Builder (Use AMD64 for DigitalOcean)
builder:
  arch: amd64
  context: "."

# 8. Environment Variables
env:
  secret:
    - RAILS_MASTER_KEY
    - POSTGRES_PASSWORD
    - DO_SPACES_KEY
    - DO_SPACES_SECRET
    - HTTP_AUTH_USER
    - HTTP_AUTH_PASSWORD
    - ADMIN_EMAIL
    - BREVO_SMTP_USERNAME 
    - BREVO_SMTP_PASSWORD 
    - CENSUS_API_KEY
  clear:
    DB_HOST: nybenchmark_app-db
    POSTGRES_USER: nybenchmark_app
    POSTGRES_DB: nybenchmark_app_production
    SOLID_QUEUE_IN_PUMA: false
    SOLID_QUEUE_ENABLED: false
    SMTP_PORT: 2525

# 9. Database Accessory
accessories:
  db:
    image: postgres:17
    host: 68.183.56.0
    # REMOVED: port: 5432 (This keeps the DB private to the docker network)
    # PG tuning â€” update these when resizing the droplet (see doc/ops.md scaling roadmap)
    cmd: postgres -c shared_buffers=512MB -c effective_cache_size=1536MB -c work_mem=4MB
    env:
      clear:
        POSTGRES_USER: nybenchmark_app
        POSTGRES_DB: nybenchmark_app_production
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data:/var/lib/postgresql/data