<main class="container">
  <div class="page-header">
    <hgroup>
      <h1><%= @entity.name %></h1>
      <p><%= @entity.kind.humanize %> in <%= @entity.state %> (New York)</p>
    </hgroup>

    <div class="button-group">
      <%= link_to "Back to Entities", entities_path, role: "button", class: "outline" %>
      <%= link_to "Edit", edit_entity_path(@entity), role: "button", class: "secondary outline" %>
    </div>
  </div>

  <%# Non-filer warning banner %>
  <% if @filing_category == :chronic %>
    <article class="non-filer-banner">
      <strong><%= @entity.name %></strong> last filed financial data with the NYS Comptroller
      <% if @last_osc_year %>
        in <%= @last_osc_year %>. Financial trends and rankings may not reflect current conditions.
      <% else %>
        — no financial data has been filed with the NYS Comptroller for this city.
      <% end %>
      <a href="<%= non_filers_path %>">View filing compliance</a>
    </article>
  <% elsif @filing_category == :recent_lapse %>
    <article class="non-filer-banner">
      <strong><%= @entity.name %></strong> has not yet filed for FY <%= @latest_majority_year %>.
      Data through FY <%= @last_osc_year %> is shown.
      <a href="<%= non_filers_path %>">View filing compliance</a>
    </article>
  <% end %>

  <%# Hero stats bar %>
  <% if @hero_stats.present? %>
    <div class="hero-stats">
      <% if @hero_stats[:population] %>
        <div class="hero-stat">
          <span class="hero-stat-value"><%= number_with_delimiter(@hero_stats[:population].to_i) %></span>
          <span class="hero-stat-label">Population</span>
        </div>
      <% end %>
      <% if @hero_stats[:fund_balance_pct] %>
        <div class="hero-stat">
          <span class="hero-stat-value"><%= @hero_stats[:fund_balance_pct] %>%</span>
          <span class="hero-stat-label">Fund Balance</span>
        </div>
      <% end %>
      <% if @hero_stats[:per_capita_spending] %>
        <div class="hero-stat">
          <span class="hero-stat-value"><%= number_to_currency(@hero_stats[:per_capita_spending], precision: 0) %></span>
          <span class="hero-stat-label">Per-Capita Spending</span>
        </div>
      <% end %>
      <% if @hero_stats[:debt_service_pct] %>
        <div class="hero-stat">
          <span class="hero-stat-value"><%= @hero_stats[:debt_service_pct] %>%</span>
          <span class="hero-stat-label">Debt Service</span>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# Financial Trends FIRST %>
  <% if any_trends? %>
    <section id="financial-trends">
      <hgroup>
        <h2>Financial Trends</h2>
        <p>Curated financial dashboard<% if @fiscal_year_range&.first %> (<%= @fiscal_year_range.first %>-<%= @fiscal_year_range.last %>)<% end %></p>
      </hgroup>

      <% if @missing_osc_years.present? %>
        <p class="trend-missing-years">
          No data filed for: <%= @missing_osc_years.sort.join(", ") %>
        </p>
      <% end %>

      <%# Fiscal Health Section %>
      <% if @balance_sheet_trends.present? || @debt_service_trends.present? %>
        <h3>Fiscal Health</h3>
        <div class="trends-grid">
          <%# Balance sheet items (Unassigned Fund Balance, Cash Position) %>
          <% @balance_sheet_trends.each do |key, info| %>
            <%= render "trend_card", label: info[:label], info: info, account_type: "balance_sheet", latest_year: @latest_majority_year %>
          <% end %>

          <%# Debt Service %>
          <% @debt_service_trends.each do |category, info| %>
            <%= render "trend_card", label: category, info: info, account_type: "expenditure", latest_year: @latest_majority_year %>
          <% end %>

          <%# Derived metrics: Fund Balance % and Debt Service % %>
          <% @derived_trends&.each do |_key, info| %>
            <% next unless info.present? && info[:data].present? %>
            <%= render "trend_card", label: info[:label], info: info, account_type: "derived", latest_year: @latest_majority_year %>
          <% end %>
        </div>
      <% end %>

      <%# Top Revenue Sources Section %>
      <% if @revenue_trends.present? %>
        <h3>Top Revenue Sources</h3>
        <div class="trends-grid">
          <% @revenue_trends.each do |category, info| %>
            <%= render "trend_card", label: category, info: info, account_type: "revenue", latest_year: @latest_majority_year %>
          <% end %>
        </div>
      <% end %>

      <%# Top Expenditures Section (excludes Debt Service) %>
      <% if @expenditure_trends.present? %>
        <h3>Top Expenditures</h3>
        <div class="trends-grid">
          <% @expenditure_trends.each do |category, info| %>
            <%= render "trend_card", label: category, info: info, account_type: "expenditure", latest_year: @latest_majority_year %>
          <% end %>
        </div>
      <% end %>
    </section>
  <% end %>

  <hr />

  <%# Documents (collapsed for SEO - reduces link equity dilution to noindex pages) %>
  <details id="documents">
    <summary><strong>Financial Documents (<%= @documents.count %>)</strong></summary>

    <% if @documents.any? %>
      <%# Show only 5 most recent documents inline %>
      <% display_docs = @documents.first(5) %>
      <figure>
        <table>
          <thead>
            <tr>
              <th>Year</th>
              <th>Title</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody>
            <% display_docs.each do |doc| %>
              <tr>
                <td><%= doc.fiscal_year %></td>
                <td><%= link_to doc.title, document_path(doc), rel: "nofollow" %></td>
                <td><small><%= doc.doc_type.upcase %></small></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </figure>

      <% if @documents.count > 5 %>
        <p>
          <%= link_to "View all #{@documents.count} documents →",
              documents_path(entity_id: @entity.id),
              rel: "nofollow" %>
        </p>
      <% end %>
    <% else %>
      <article class="text-center">
        <p>No financial documents yet for <%= @entity.name %>.</p>
        <% if user_signed_in? %>
          <p><%= link_to "Add a document", new_document_path(entity_id: @entity.id), role: "button", class: "outline" %></p>
        <% else %>
          <p class="muted"><%= link_to "Sign in", new_user_session_path %> to contribute data.</p>
        <% end %>
      </article>
    <% end %>
  </details>

  <%# Governance details (collapsed below fold) %>
  <details id="governance">
    <summary><strong>Governance & Structure</strong></summary>

    <div class="grid">
      <article>
        <header><strong>Governance Structure</strong></header>
        <dl>
          <dt>Structure</dt>
          <dd><%= @entity.government_structure&.humanize || content_tag(:em, "Not specified", class: "needs-research") %></dd>

          <dt>Fiscal Autonomy</dt>
          <dd><%= @entity.fiscal_autonomy&.humanize || content_tag(:em, "Not specified", class: "needs-research") %></dd>

          <% if @entity.dependent_fiscal_autonomy? || @entity.parent.present? %>
            <dt>Parent Entity</dt>
            <dd>
              <% if @entity.parent.present? %>
                <%= link_to @entity.parent.name, entity_path(@entity.parent) %>
              <% else %>
                <%= content_tag(:em, "Not specified", class: "needs-research") %>
              <% end %>
            </dd>
          <% end %>

          <dt>ICMA Recognition</dt>
          <dd>
            <% if @entity.icma_recognition_year.present? %>
              ICMA-recognized since <%= @entity.icma_recognition_year %>
            <% else %>
              —
            <% end %>
          </dd>

          <dt>Notes</dt>
          <dd><%= @entity.organization_note.presence || content_tag(:em, "None", class: "muted") %></dd>

          <% if @entity.osc_municipal_code.present? %>
            <dt>OSC Code</dt>
            <dd><code><%= @entity.osc_municipal_code %></code></dd>
          <% end %>
        </dl>
      </article>

      <article>
        <header><strong>School Details</strong></header>
        <% if @entity.school_district_kind? %>
          <dl>
            <dt>Legal Type</dt>
            <dd><%= @entity.school_legal_type&.humanize %></dd>

            <dt>Board Selection</dt>
            <dd><%= @entity.board_selection&.humanize %></dd>

            <dt>Executive</dt>
            <dd><%= @entity.executive_selection&.humanize %></dd>
          </dl>
        <% else %>
          <p><em>Not applicable for this entity type.</em></p>
        <% end %>
      </article>
    </div>

    <% if @entity.children.any? %>
      <article>
        <header><strong>Dependent Entities</strong></header>
        <p>Fiscally dependent entities that roll up to <%= @entity.name %>:</p>
        <ul>
          <% @entity.children.order(:name).each do |child| %>
            <li><%= link_to child.name, entity_path(child) %> (<%= child.kind.humanize %>)</li>
          <% end %>
        </ul>
      </article>
    <% end %>
  </details>

  <%# Recent Data (de-emphasized) %>
  <section id="observations">
    <hgroup>
      <h2>Recent Data</h2>
      <p>Latest extracted metrics.</p>
    </hgroup>

    <% if @observations.any? %>
      <figure>
        <table>
          <thead>
            <tr>
              <th>Metric</th>
              <th>Value</th>
              <th>Year</th>
            </tr>
          </thead>
          <tbody>
            <% @observations.each do |obs| %>
              <tr>
                <td><%= obs.metric.label %></td>
                <td>
                  <%= obs.value_numeric ? number_with_delimiter(obs.value_numeric) : obs.value_text %>
                  <% if obs.metric.unit && obs.value_numeric %>
                    <small><%= obs.metric.unit %></small>
                  <% end %>
                </td>
                <td><%= obs.fiscal_year %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </figure>
    <% else %>
      <article class="text-center">
        <p>No data points extracted yet for <%= @entity.name %>.</p>
        <% if user_signed_in? %>
          <p><%= link_to "Add an observation", new_observation_path(entity_id: @entity.id), role: "button", class: "outline" %></p>
        <% else %>
          <p class="muted"><%= link_to "Sign in", new_user_session_path %> to contribute data.</p>
        <% end %>
      </article>
    <% end %>
  </section>

  <style>
    .text-center {
      text-align: center;
    }
  </style>
</main>
