<main class="container">
  <div class="page-header">
    <hgroup>
      <h1><%= @entity.name %></h1>
      <p><%= @entity.kind.humanize %> in <%= @entity.state %> (New York)</p>
    </hgroup>

    <div class="button-group">
      <%= link_to "Back to Entities", entities_path, role: "button", class: "outline" %>
      <%= link_to "Edit", edit_entity_path(@entity), role: "button", class: "secondary outline" %>
    </div>
  </div>

  <% if @entity.government_structure.blank? && !@entity.school_district_kind? %>
    <article class="needs-research-banner">
      <strong>Help wanted:</strong> Government structure information is missing for <%= @entity.name %>.
      <% if user_signed_in? %>
        <%= link_to "Add governance details", edit_entity_path(@entity) %>
      <% else %>
        <%= link_to "Sign in", new_user_session_path %> to contribute.
      <% end %>
    </article>
  <% end %>

  <hr />

    <div class="grid">
      <article>
        <header><strong>Governance Structure</strong></header>
        <dl>
          <dt>Structure</dt>
          <dd><%= @entity.government_structure&.humanize || content_tag(:em, "Not specified", class: "needs-research") %></dd>

          <dt>Fiscal Autonomy</dt>
          <dd><%= @entity.fiscal_autonomy&.humanize || content_tag(:em, "Not specified", class: "needs-research") %></dd>

          <% if @entity.dependent_fiscal_autonomy? || @entity.parent.present? %>
            <dt>Parent Entity</dt>
            <dd>
              <% if @entity.parent.present? %>
                <%= link_to @entity.parent.name, entity_path(@entity.parent) %>
              <% else %>
                <%= content_tag(:em, "Not specified", class: "needs-research") %>
              <% end %>
            </dd>
          <% end %>

          <dt>ICMA Recognition</dt>
          <dd>
            <% if @entity.icma_recognition_year.present? %>
              ICMA-recognized since <%= @entity.icma_recognition_year %>
            <% else %>
              â€”
            <% end %>
          </dd>

          <dt>Notes</dt>
          <dd><%= @entity.organization_note.presence || content_tag(:em, "None", class: "muted") %></dd>
        </dl>
        <% if @entity.government_structure.blank? && !@entity.school_district_kind? && user_signed_in? %>
          <p><%= link_to "Add details", edit_entity_path(@entity), class: "outline" %></p>
        <% end %>
      </article>

      <article>
        <header><strong>School Details</strong></header>
        <% if @entity.school_district_kind? %>
          <dl>
            <dt>Legal Type</dt>
            <dd><%= @entity.school_legal_type&.humanize %></dd>

            <dt>Board Selection</dt>
            <dd><%= @entity.board_selection&.humanize %></dd>

            <dt>Executive</dt>
            <dd><%= @entity.executive_selection&.humanize %></dd>
          </dl>
        <% else %>
          <p><em>Not applicable for this entity type.</em></p>
        <% end %>
      </article>
    </div>

    <% if @entity.children.any? %>
      <article>
        <header><strong>Dependent Entities</strong></header>
        <p>Fiscally dependent entities that roll up to <%= @entity.name %>:</p>
        <ul>
          <% @entity.children.order(:name).each do |child| %>
            <li><%= link_to child.name, entity_path(child) %> (<%= child.kind.humanize %>)</li>
          <% end %>
        </ul>
      </article>
    <% end %>
  <hr />

  <div class="grid">
    <section id="documents">
      <hgroup>
        <h2>Financial Documents</h2>
        <p>Official sources ingested.</p>
      </hgroup>
      
      <% if @documents.any? %>
        <figure>
          <table>
            <thead>
              <tr>
                <th>Year</th>
                <th>Title</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody>
              <% @documents.each do |doc| %>
                <tr>
                  <td><%= doc.fiscal_year %></td>
                  <td><%= link_to doc.title, document_path(doc) %></td>
                  <td><small><%= doc.doc_type.upcase %></small></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </figure>
      <% else %>
        <article class="text-center">
          <p>No financial documents yet for <%= @entity.name %>.</p>
          <% if user_signed_in? %>
            <p><%= link_to "Add a document", new_document_path(entity_id: @entity.id), role: "button", class: "outline" %></p>
          <% else %>
            <p class="muted"><%= link_to "Sign in", new_user_session_path %> to contribute data.</p>
          <% end %>
        </article>
      <% end %>
    </section>

    <section id="observations">
      <hgroup>
        <h2>Recent Data</h2>
        <p>Latest extracted metrics.</p>
      </hgroup>

      <% if @observations.any? %>
        <figure>
          <table>
            <thead>
              <tr>
                <th>Metric</th>
                <th>Value</th>
                <th>Year</th>
              </tr>
            </thead>
            <tbody>
              <% @observations.each do |obs| %>
                <tr>
                  <td><%= obs.metric.label %></td>
                  <td>
                    <%= obs.value_numeric ? number_with_delimiter(obs.value_numeric) : obs.value_text %>
                    <% if obs.metric.unit && obs.value_numeric %>
                      <small><%= obs.metric.unit %></small>
                    <% end %>
                  </td>
                  <td><%= obs.fiscal_year %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </figure>
      <% else %>
        <article class="text-center">
          <p>No data points extracted yet for <%= @entity.name %>.</p>
          <% if user_signed_in? %>
            <p><%= link_to "Add an observation", new_observation_path(entity_id: @entity.id), role: "button", class: "outline" %></p>
          <% else %>
            <p class="muted"><%= link_to "Sign in", new_user_session_path %> to contribute data.</p>
          <% end %>
        </article>
      <% end %>
    </section>
  </div>

  <style>
    .needs-research-banner {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
    }
    .needs-research-banner a {
      color: #856404;
      font-weight: bold;
    }
    .needs-research {
      color: #856404;
    }
    .muted {
      color: #6c757d;
    }
    .text-center {
      text-align: center;
    }
  </style>
</main>