<main class="container">
  <div class="page-header page-header--center">
    <hgroup>
      <h1>New York Entities</h1>
      <p>Select a local government to view financial performance and documents.</p>
    </hgroup>

    <div>
      <%= link_to "New Entity", new_entity_path, role: "button" %>
    </div>
  </div>

  <form method="get" action="<%= entities_path %>">
    <%# Preserve sort params when filtering %>
    <%= hidden_field_tag :sort, params[:sort] if params[:sort].present? %>
    <%= hidden_field_tag :direction, params[:direction] if params[:direction].present? %>

    <fieldset>
      <legend>Filters</legend>
      <div class="grid">
        <label>
          Type
          <%= select_tag :kind,
                options_for_select(
                  Entity.kinds.keys.map { |k| [k.titleize, k] },
                  params[:kind]
                ),
                prompt: "All Types" %>
        </label>

        <label>
          Government Structure
          <%= select_tag :government_structure,
                options_for_select(
                  Entity.government_structures.keys.map { |k| [k.titleize, k] },
                  params[:government_structure]
                ),
                prompt: "All Structures" %>
        </label>

        <div class="button-group">
          <%= link_to "Clear", entities_path, role: "button", class: "secondary outline" %>
          <%= submit_tag "Apply", name: nil %>
        </div>
      </div>
    </fieldset>
  </form>

  <figure>
    <table role="grid">
      <thead>
        <tr>
          <th scope="col">
            <%= sortable_column_header(
                  column: "name",
                  label: "Name",
                  path: :entities_path,
                  current_sort: params[:sort],
                  current_direction: params[:direction]
                ) %>
          </th>
          <th scope="col">
            <%= sortable_column_header(
                  column: "kind",
                  label: "Type",
                  path: :entities_path,
                  current_sort: params[:sort],
                  current_direction: params[:direction]
                ) %>
          </th>
          <th scope="col">
            <%= sortable_column_header(
                  column: "government_structure",
                  label: "Gov. Structure",
                  path: :entities_path,
                  current_sort: params[:sort],
                  current_direction: params[:direction]
                ) %>
          </th>
          <th scope="col">Fiscal</th>
          <th scope="col">
            <%= sortable_column_header(
                  column: "documents_count",
                  label: "Docs",
                  path: :entities_path,
                  current_sort: params[:sort],
                  current_direction: params[:direction],
                  default_direction: "desc"
                ) %>
          </th>
          <th scope="col">
            <%= sortable_column_header(
                  column: "observations_count",
                  label: "Obs",
                  path: :entities_path,
                  current_sort: params[:sort],
                  current_direction: params[:direction],
                  default_direction: "desc"
                ) %>
          </th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @entities.each do |entity| %>
          <tr>
            <td><%= link_to entity.name, entity_path(entity.slug) %></td>
            <td><%= entity.kind.humanize %></td>
            <td>
              <% if entity.government_structure.present? %>
                <%= entity.government_structure.humanize %>
              <% else %>
                <mark class="missing-data">Needs research</mark>
              <% end %>
            </td>
            <td>
              <% if entity.fiscal_autonomy.present? %>
                <%= entity.fiscal_autonomy.humanize %>
                <% if entity.parent.present? %>
                  <small>(<%= link_to entity.parent.name, entity_path(entity.parent) %>)</small>
                <% end %>
              <% else %>
                <small class="muted">â€”</small>
              <% end %>
            </td>
            <td>
              <% if entity.documents_count.to_i > 0 %>
                <%= entity.documents_count %>
              <% else %>
                <small class="muted">0</small>
              <% end %>
            </td>
            <td>
              <% if entity.observations_count.to_i > 0 %>
                <%= entity.observations_count %>
              <% else %>
                <small class="muted">0</small>
              <% end %>
            </td>
            <td>
              <%= link_to "View", entity_path(entity.slug), role: "button", class: "outline" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </figure>

  <% if @pagy.pages > 1 %>
    <section>
      <%== @pagy.info_tag %>
      <%== @pagy.series_nav(aria_label: "Entity pages") %>
    </section>
  <% end %>
</main>