<%
  # Build chart data in Chartkick scatter format
  # For multiple series: [{name: "Series", data: [[x, y], ...]}, ...]

  # Convert to floats for both chart and tooltip lookup (must match exactly)
  normalized_data = data.map do |series|
    {
      name: series[:name],
      data: series[:data].map { |pt| { x: pt[:x].to_f, y: pt[:y].to_f, name: pt[:name] } },
      backgroundColor: series[:backgroundColor]
    }
  end

  chart_series = normalized_data.map do |series|
    points = series[:data].map { |pt| [pt[:x], pt[:y]] }
    { name: series[:name], data: points, color: series[:backgroundColor] }
  end

  # Chart.js configuration
  chart_library = {
    scales: {
      x: {
        title: { display: true, text: x_label }
      },
      y: {
        title: { display: true, text: y_label }
      }
    },
    plugins: {
      legend: { display: false }
    },
    elements: {
      point: { radius: 5, hoverRadius: 7 }
    }
  }
%>

<div data-controller="scatter-tooltip"
     data-scatter-tooltip-points-value="<%= normalized_data.to_json %>"
     data-scatter-tooltip-x-format-value="<%= x_format %>"
     data-scatter-tooltip-y-format-value="<%= y_format %>"
     data-scatter-tooltip-x-label-value="<%= x_label %>"
     data-scatter-tooltip-y-label-value="<%= y_label %>">
  <%= scatter_chart chart_series,
                    height: "500px",
                    id: "scatter-chart",
                    library: chart_library %>
</div>
