<div class="w-full h-full flex flex-col md:flex-row overflow-hidden"
     data-controller="pdf-navigator"
     data-pdf-navigator-url-value="<%= @observation.document&.file&.attached? ? rails_blob_url(@observation.document.file, disposition: :inline) : '' %>"
     data-pdf-navigator-initial-page-value="<%= @observation.pdf_page || 1 %>">

  <%= render "pdf_viewer", observation: @observation %>

  <div class="w-full md:w-2/5 h-1/2 md:h-full overflow-y-auto px-2 py-1 bg-white">
    <h2 class="text-base font-semibold text-gray-900 mb-2">Edit Observation</h2>

    <%= form_with(model: @observation, class: "verification-form") do |form| %>
      <%= render "error_messages", observation: @observation %>
      <%= render "entity_document_metric_selects", form: form, observation: @observation %>

      <%# PDF Page - only when document has PDF %>
      <% if @observation.document&.file&.attached? %>
        <div class="bg-blue-50 px-2 py-1 rounded border border-blue-200 mb-1">
          <div class="flex items-center gap-2">
            <%= form.label :pdf_page, "PDF Page (Absolute Index)", class: "text-xs font-semibold text-blue-900" %>
            <%= form.number_field :pdf_page, min: 1, class: "w-16 text-sm rounded border-gray-300 shadow-sm px-1 py-0.5 font-mono", placeholder: "1",
                data: { pdf_navigator_target: "pageInput", action: "input->pdf-navigator#goToPage" } %>
            <span class="text-xs text-blue-600">Click PDF or Capture</span>
          </div>
        </div>
      <% end %>

      <%# Citation - required for PDF documents, optional for web documents %>
      <% is_pdf_document = @observation.document&.pdf? %>
      <div class="mb-1">
        <%= form.label :page_reference, "Citation (printed page)", class: "block text-xs font-medium text-gray-700" %>
        <%= form.text_field :page_reference,
            placeholder: is_pdf_document ? "p. 42" : "e.g. Table DP05 (optional)",
            required: is_pdf_document,
            class: "mt-0.5 block w-full text-sm rounded border-gray-300 shadow-sm px-2 py-1" %>
        <% unless is_pdf_document %>
          <p class="text-xs text-gray-500 mt-0.5">Optional for web sources.</p>
        <% end %>
      </div>

      <%# Source URL %>
      <% if @observation.document.present? %>
        <%= form.fields_for :document, @observation.document do |doc_form| %>
          <%= doc_form.hidden_field :id %>
          <div class="mb-1">
            <%= doc_form.label :source_url, "Source URL", class: "block text-xs font-medium text-gray-700" %>
            <%= doc_form.url_field :source_url, class: "mt-0.5 block w-full text-sm rounded border-gray-300 shadow-sm px-2 py-1", placeholder: "https://..." %>
          </div>
        <% end %>
      <% end %>

      <%# Notes %>
      <div class="mb-1">
        <%= form.label :notes, "Notes", class: "block text-xs font-medium text-gray-700" %>
        <%= form.text_area :notes, rows: 2, placeholder: "Optional...", class: "mt-0.5 block w-full text-sm rounded border-gray-300 shadow-sm px-2 py-1" %>
      </div>

      <div class="pt-1 border-t border-gray-200 flex items-center gap-2">
        <%= form.submit "Update Observation", class: "px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-semibold cursor-pointer" %>
        <%= link_to "Show", @observation, class: "px-2 py-1 text-xs text-gray-500 hover:text-gray-900" %>
        <%= link_to "Cancel", observations_path, class: "px-2 py-1 text-xs text-gray-500 hover:text-gray-900 ml-auto" %>
      </div>
    <% end %>
  </div>
</div>
