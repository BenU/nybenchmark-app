<%# Shared form fields for observations - used by new, edit, and verify views %>
<%# Required locals: form, observation %>
<%# Optional locals: show_source_url (default true) %>

<% show_source_url = local_assigns.fetch(:show_source_url, true) %>

<%# PDF Page - compact blue box (only when document has PDF) %>
<% if observation.document&.file&.attached? %>
  <div class="bg-blue-50 px-2 py-1 rounded border border-blue-200 mb-1">
    <div class="flex items-center gap-2">
      <%= form.label :pdf_page, "PDF Page:", class: "text-xs font-semibold text-blue-900" %>
      <%= form.number_field :pdf_page,
          min: 1,
          class: "w-16 text-sm rounded border-gray-300 shadow-sm px-1 py-0.5 font-mono",
          placeholder: "1",
          data: { pdf_navigator_target: "pageInput", action: "input->pdf-navigator#goToPage" }
      %>
      <span class="text-xs text-blue-600">Click PDF or Capture</span>
    </div>
  </div>
<% end %>

<%# Citation - right below PDF Page since they're related %>
<div class="mb-1">
  <%= form.label :page_reference, "Citation (printed page)", class: "block text-xs font-medium text-gray-700" %>
  <%= form.text_field :page_reference, placeholder: "p. 42", class: "mt-0.5 block w-full text-sm rounded border-gray-300 shadow-sm px-2 py-1" %>
</div>

<%# Source URL - editable to confirm/correct document source %>
<% if show_source_url && observation.document.present? %>
  <%= form.fields_for :document, observation.document do |doc_form| %>
    <%= doc_form.hidden_field :id %>
    <div class="mb-1">
      <%= doc_form.label :source_url, "Source URL", class: "block text-xs font-medium text-gray-700" %>
      <%= doc_form.url_field :source_url, class: "mt-0.5 block w-full text-sm rounded border-gray-300 shadow-sm px-2 py-1", placeholder: "https://..." %>
    </div>
  <% end %>
<% end %>

<%# Value input - conditional based on metric type %>
<% if observation.metric.present? %>
  <div class="mb-1">
    <% if observation.metric.expects_numeric? %>
      <%= form.label :value_numeric, "Value (#{observation.metric.unit || 'numeric'})", class: "block text-xs font-medium text-gray-700" %>
      <%= form.number_field :value_numeric, step: :any, class: "mt-0.5 block w-full text-sm rounded border-gray-300 shadow-sm px-2 py-1" %>
      <% if observation.value_numeric.present? %>
        <p class="mt-0.5 text-xs text-gray-500" data-formatted-preview>
          Displays as: <span class="font-medium"><%= observation.metric.format_value(observation.value_numeric) %></span>
        </p>
      <% end %>
    <% else %>
      <%= form.label :value_text, "Value (text)", class: "block text-xs font-medium text-gray-700" %>
      <%= form.text_field :value_text, class: "mt-0.5 block w-full text-sm rounded border-gray-300 shadow-sm px-2 py-1" %>
    <% end %>
  </div>
<% end %>

<%# Notes - compact %>
<div class="mb-1">
  <%= form.label :notes, "Notes", class: "block text-xs font-medium text-gray-700" %>
  <%= form.text_area :notes, rows: 2, placeholder: "Optional...", class: "mt-0.5 block w-full text-sm rounded border-gray-300 shadow-sm px-2 py-1" %>
</div>
