<%= form_with(model: observation, class: "contents") do |form| %>
  <% if observation.errors.any? %>
    <div class="bg-red-50 text-red-700 p-4 rounded-md mb-6">
      <h2 class="font-bold"><%= pluralize(observation.errors.count, "error") %> prohibited saving:</h2>
      <ul class="list-disc pl-5">
        <% observation.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="my-5">
    <%= form.label :entity_id, class: "block font-medium" %>
    <%= form.collection_select :entity_id, @entities, :id, :name, 
          { prompt: "Select Entity..." }, 
          { 
            class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-full",
            data: { 
              controller: "redirect-on-change",
              redirect_on_change_param_value: "entity_id",
              action: "change->redirect-on-change#update"
            }
          } 
    %>
    <p class="text-xs text-gray-500 mt-1">Changing this filters the document list.</p>
  </div>

  <div class="my-5">
    <%= form.label :document_id, class: "block font-medium" %>
    <% if @documents.any? %>
      <%= form.collection_select :document_id, @documents, :id, :title, 
            { prompt: "Select Document..." }, 
            { class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-full" } 
      %>
      <p class="text-xs text-gray-500 mt-1">Fiscal Year will be automatically assigned.</p>
    <% else %>
      <%= form.select :document_id, [], { prompt: "Please select an Entity above" }, 
            { disabled: true, class: "block shadow rounded-md border border-gray-200 bg-gray-100 px-3 py-2 mt-2 w-full" } 
      %>
    <% end %>
  </div>

  <%# Build metric types map for Stimulus controller %>
  <% metric_types = @metrics.each_with_object({}) { |m, h| h[m.id.to_s] = m.value_type } %>

  <div data-controller="metric-value-field"
       data-metric-value-field-metric-types-value="<%= metric_types.to_json %>">

    <div class="my-5">
      <%= form.label :metric_id, class: "block font-medium" %>
      <%= form.collection_select :metric_id, @metrics, :id, :label,
            { prompt: "Select Metric..." },
            {
              class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-full",
              data: {
                metric_value_field_target: "metricSelect",
                action: "change->metric-value-field#metricChanged"
              }
            }
      %>
    </div>

    <div class="my-5 border p-4 rounded bg-gray-50">
      <% if observation.metric&.persisted? %>
        <%# When editing with a known metric, show only the relevant field %>
        <% if observation.metric.expects_numeric? %>
          <h3 class="font-bold text-gray-700 mb-4">Value (<%= observation.metric.unit || "Numeric" %>)</h3>
          <div>
            <%= form.label :value_numeric, "Numeric Value" %>
            <%= form.number_field :value_numeric, step: :any, class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-full" %>
            <% if observation.value_numeric.present? %>
              <p class="text-xs text-gray-500 mt-1">
                Displays as: <span class="font-medium"><%= observation.metric.format_value(observation.value_numeric) %></span>
              </p>
            <% end %>
          </div>
        <% else %>
          <h3 class="font-bold text-gray-700 mb-4">Value (Text)</h3>
          <div>
            <%= form.label :value_text, "Text Value" %>
            <%= form.text_field :value_text, class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-full" %>
          </div>
        <% end %>
      <% else %>
        <%# For new observations, use dynamic field switching %>
        <h3 class="font-bold text-gray-700 mb-4">Value</h3>

        <%# Placeholder shown when no metric selected %>
        <div data-metric-value-field-target="placeholder">
          <p class="text-gray-500 text-sm">Select a metric to see value field</p>
        </div>

        <%# Numeric field (hidden by default) %>
        <div data-metric-value-field-target="numericField" class="hidden">
          <%= form.label :value_numeric, "Numeric Value" %>
          <%= form.number_field :value_numeric, step: :any, class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-full" %>
        </div>

        <%# Text field (hidden by default) %>
        <div data-metric-value-field-target="textField" class="hidden">
          <%= form.label :value_text, "Text Value" %>
          <%= form.text_field :value_text, class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-full" %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="my-5">
    <%= form.label :page_reference, class: "block font-medium" %>
    <%= form.text_field :page_reference, placeholder: "e.g. p. 42", class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-full" %>
  </div>

  <% if observation.persisted? && observation.document&.file&.attached? %>
    <div class="my-5">
      <%= form.label :pdf_page, "PDF Page (Absolute Index)", class: "block font-medium" %>
      <%= form.number_field :pdf_page, min: 1, placeholder: "e.g. 45", class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-full" %>
      <p class="text-xs text-gray-500 mt-1">The page number in the PDF file (use the Verify Cockpit to capture this automatically).</p>
    </div>
  <% end %>

  <div class="my-5">
    <%= form.label :notes, class: "block font-medium" %>
    <%= form.text_area :notes, rows: 3, class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-full" %>
  </div>

  <div class="inline">
    <%= form.submit class: "rounded-lg py-3 px-5 bg-blue-600 text-white inline-block font-medium cursor-pointer" %>
  </div>
<% end %>