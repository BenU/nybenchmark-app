<% content_for :title, "Observations" %>

<div class="grid">
  <hgroup>
    <h1>Observations</h1>
    <p>Audit-first browsing: every value is traceable to a document and page reference.</p>
  </hgroup>
  
  <% if user_signed_in? %>
    <div style="text-align: right; align-self: center;">
      <%= link_to "New observation", new_observation_path, role: "button" %>
    </div>
  <% end %>
</div>

<%# Render the extracted search form %>
<%= render "search_form" %>

<figure>
  <table role="grid">
    <thead>
      <tr>
        <th>Entity</th>
        <th>Metric</th>
        <th>Fiscal year</th>
        <th>Value</th>
        <% if user_signed_in? %><th>Status</th><% end %>
        <th>Document</th>
        <th>PDF Page</th>
        <th>Updated at</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      <% @observations.each do |observation| %>
        <tr>
          <td><%= link_to observation.entity.name, entity_path(observation.entity.slug) %></td>

          <td>
            <%= link_to metric_path(observation.metric) do %>
              <%= observation.metric.label %>
            <% end %>
          </td>

          <td><%= observation.fiscal_year %></td>

          <td>
            <% if observation.value_numeric.present? %>
              <%= number_with_delimiter(observation.value_numeric) %>
            <% else %>
              <%= observation.value_text %>
            <% end %>
          </td>

          <% if user_signed_in? %>
            <td>
              <%= render "status_badge", status: observation.verification_status %>
            </td>
          <% end %>

          <td>
            <%= link_to observation.document.title, document_path(observation.document) %>
            <br>
            <small class="text-muted"><%= observation.page_reference %></small>
          </td>

          <td><%= observation.pdf_page %></td>

          <td><%= observation.updated_at.to_fs(:short) %></td>

          <td>
            <%= link_to "View", observation %>
            <% if user_signed_in? %>
              | <%= link_to "Edit", edit_observation_path(observation) %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</figure>

<% if @pagy.pages > 1 %>
  <section>
    <%== @pagy.info_tag %>
    <%== @pagy.series_nav(aria_label: "Observation pages") %>
  </section>
<% end %>