<% content_for :title, "Observations" %>

<div class="grid">
  <hgroup>
    <h1>Observations</h1>
    <p>Audit-first browsing: every value is traceable to a document and page reference.</p>
  </hgroup>

  <% if user_signed_in? %>
    <div class="text-right align-self-center">
      <%= link_to "New observation", new_observation_path, role: "button" %>
    </div>
  <% end %>
</div>

<%# Render the extracted search form %>
<%= render "search_form" %>

<figure>
  <table role="grid">
    <thead>
      <tr>
        <th>
          <%= sortable_column_header(
                column: "entity_name",
                label: "Entity",
                path: :observations_path,
                current_sort: params[:sort],
                current_direction: params[:direction]
              ) %>
        </th>
        <th>
          <%= sortable_column_header(
                column: "metric_label",
                label: "Metric",
                path: :observations_path,
                current_sort: params[:sort],
                current_direction: params[:direction]
              ) %>
        </th>
        <th>
          <%= sortable_column_header(
                column: "fiscal_year",
                label: "Year",
                path: :observations_path,
                current_sort: params[:sort],
                current_direction: params[:direction],
                default_direction: "desc"
              ) %>
        </th>
        <th>Value</th>
        <% if user_signed_in? %><th>Status</th><% end %>
        <th>Document</th>
        <th>PDF Page</th>
        <th>
          <%= sortable_column_header(
                column: "updated_at",
                label: "Updated",
                path: :observations_path,
                current_sort: params[:sort],
                current_direction: params[:direction],
                default_direction: "desc"
              ) %>
        </th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      <% @observations.each do |observation| %>
        <tr>
          <td><%= link_to observation.entity.name, entity_path(observation.entity.slug) %></td>

          <td>
            <%= link_to metric_path(observation.metric) do %>
              <%= observation.metric.label %>
            <% end %>
          </td>

          <td><%= observation.fiscal_year %></td>

          <td>
            <% if observation.metric.expects_numeric? %>
              <%= observation.metric.format_value(observation.value_numeric) %>
            <% else %>
              <%= observation.value_text %>
            <% end %>
          </td>

          <% if user_signed_in? %>
            <td>
              <%= render "status_badge", status: observation.verification_status %>
            </td>
          <% end %>

          <td>
            <%= link_to observation.document.title, document_path(observation.document) %>
            <br>
            <small class="text-muted"><%= observation.page_reference %></small>
          </td>

          <td><%= observation.pdf_page %></td>

          <td><%= observation.updated_at.to_fs(:short) %></td>

          <td>
            <%= link_to "View", observation %>
            <% if user_signed_in? %>
              | <%= link_to "Edit", edit_observation_path(observation) %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</figure>

<% if @pagy.pages > 1 %>
  <section>
    <%== @pagy.info_tag %>
    <%== @pagy.series_nav(aria_label: "Observation pages") %>
  </section>
<% end %>